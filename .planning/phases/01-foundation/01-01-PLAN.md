---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/supabase/client.ts
  - src/lib/supabase/server.ts
  - src/lib/supabase/admin.ts
  - src/lib/utils.ts
  - src/proxy.ts
  - src/app/globals.css
  - .env.local
  - package.json
autonomous: true
user_setup:
  - service: supabase
    why: "Database, auth, and storage backend"
    env_vars:
      - name: NEXT_PUBLIC_SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API -> Project URL"
      - name: NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> anon/public key"
      - name: SUPABASE_SERVICE_ROLE_KEY
        source: "Supabase Dashboard -> Project Settings -> API -> service_role key"

must_haves:
  truths:
    - "Next.js dev server starts without errors on localhost:3000"
    - "Supabase browser client can be imported and instantiated"
    - "Supabase server client handles cookies with getAll/setAll"
    - "Supabase admin client is protected by server-only guard"
    - "proxy.ts refreshes tokens and redirects unauthenticated users"
    - "Tailwind v4 organic color theme renders correctly"
  artifacts:
    - path: "src/lib/supabase/client.ts"
      provides: "Browser Supabase client"
      contains: "createBrowserClient"
    - path: "src/lib/supabase/server.ts"
      provides: "Server Supabase client with cookie handling"
      contains: "createServerClient"
    - path: "src/lib/supabase/admin.ts"
      provides: "Admin Supabase client with service_role"
      contains: "server-only"
    - path: "src/proxy.ts"
      provides: "Token refresh and optimistic auth redirect"
      contains: "export async function proxy"
    - path: "src/app/globals.css"
      provides: "Tailwind v4 theme with organic color palette"
      contains: "@theme inline"
  key_links:
    - from: "src/proxy.ts"
      to: "Supabase Auth"
      via: "getClaims() for JWT validation"
      pattern: "getClaims"
    - from: "src/lib/supabase/server.ts"
      to: "next/headers cookies"
      via: "async cookies() with getAll/setAll"
      pattern: "await cookies"
---

<objective>
Create the Next.js 16 project with Tailwind v4, shadcn/ui, three Supabase clients, proxy.ts for token refresh, and the organic color theme.

Purpose: Establish the project foundation that all subsequent plans and phases build on. Without this, nothing else can run.
Output: A running Next.js 16 dev server with Supabase integration, organic CSS theme, and proxy-level auth token refresh.
</objective>

<execution_context>
@/home/thibault/.claude/get-shit-done/workflows/execute-plan.md
@/home/thibault/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Next.js 16 project, install dependencies, initialize shadcn/ui</name>
  <files>
    package.json
    src/app/globals.css
    src/lib/utils.ts
    .env.local
  </files>
  <action>
    1. Create the Next.js 16 project in the current directory (the project IS the repo root):
       ```
       npx create-next-app@latest . --ts --tailwind --app --src-dir --import-alias "@/*"
       ```
       Accept defaults. If the command asks about overwriting, allow it (directory has only .planning/ and doc/).

    2. Initialize shadcn/ui:
       ```
       npx shadcn@latest init
       ```
       Choose: New York style, default color scheme. It will auto-detect Tailwind v4.

    3. Install all dependencies in one command:
       ```
       npm install @supabase/supabase-js @supabase/ssr @trpc/server @trpc/client @trpc/tanstack-react-query @tanstack/react-query zod superjson server-only client-only
       ```

    4. Replace the generated globals.css with the organic color theme from RESEARCH.md (the full CSS with @import "tailwindcss", @import "tw-animate-css", @custom-variant dark, :root vars with oklch warm earthy tones -- hue 90 warm gray, hue 160 muted green primary, .dark vars, and @theme inline block). Keep any additional CSS that shadcn init may have added (like @layer base body styles), but replace the color variables with the organic palette.

    5. Create .env.local with placeholder values:
       ```
       NEXT_PUBLIC_SUPABASE_URL=https://your-project.supabase.co
       NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY=your_publishable_key
       SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
       NEXT_PUBLIC_APP_URL=http://localhost:3000
       ```

    6. Ensure src/lib/utils.ts has the cn() helper (shadcn should create this, but verify it uses clsx + tailwind-merge).

    IMPORTANT: Do NOT modify tailwind.config.js/ts -- Tailwind v4 uses CSS-first config via @theme inline. If create-next-app generates one, it can be left as-is or removed (shadcn handles this).
  </action>
  <verify>
    Run `npm run dev` and confirm the dev server starts on localhost:3000 without errors. Run `npm run build` and confirm it builds successfully.
  </verify>
  <done>
    Next.js 16 dev server starts, build succeeds, shadcn/ui is initialized, all dependencies installed, organic theme CSS is in place.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create three Supabase clients and proxy.ts</name>
  <files>
    src/lib/supabase/client.ts
    src/lib/supabase/server.ts
    src/lib/supabase/admin.ts
    src/proxy.ts
  </files>
  <action>
    1. Create src/lib/supabase/client.ts (browser client):
       - Import createBrowserClient from @supabase/ssr
       - Export function createClient() that returns createBrowserClient with NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY
       - This is the ONLY client used in 'use client' components

    2. Create src/lib/supabase/server.ts (server client):
       - Import createServerClient from @supabase/ssr
       - Import cookies from next/headers (MUST await it -- Next.js 16 async API)
       - Export async function createClient() that:
         a. Awaits cookies(): `const cookieStore = await cookies()`
         b. Creates server client with getAll() and setAll() cookie methods
         c. setAll wraps in try/catch (read-only in Server Components)
       - Use ONLY getAll/setAll, NEVER individual get/set/remove

    3. Create src/lib/supabase/admin.ts (admin client):
       - Import 'server-only' FIRST (prevents client-side import)
       - Import createClient from @supabase/supabase-js (NOT from @supabase/ssr)
       - Export const supabaseAdmin using SUPABASE_SERVICE_ROLE_KEY
       - NEVER prefix service_role key with NEXT_PUBLIC_

    4. Create src/proxy.ts (NOT middleware.ts):
       - MUST export async function named "proxy" (not "middleware")
       - Uses createServerClient from @supabase/ssr with request cookies
       - Calls getClaims() for fast local JWT validation and auto token refresh
       - Redirects unauthenticated users to /login (except for /login, /auth, and / paths)
       - Export config with matcher that excludes static files
       - This is NOT an auth gate (CVE-2025-29927) -- it's for token refresh and optimistic redirects
       - Real auth happens in tRPC authedProcedure and Server Components

    Follow the exact code patterns from RESEARCH.md. Do not deviate.
  </action>
  <verify>
    Run `npx tsc --noEmit` (or `npm run build`) to confirm no TypeScript errors. Verify proxy.ts exports a function named "proxy" and includes the matcher config.
  </verify>
  <done>
    Three Supabase clients exist (browser, server, admin) with correct patterns. proxy.ts handles token refresh with getClaims(). Build passes with no type errors.
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` starts without errors
2. `npm run build` completes successfully
3. Visiting localhost:3000 shows the default Next.js page with the organic theme colors
4. `npx tsc --noEmit` reports no TypeScript errors
5. proxy.ts contains `export async function proxy`
6. admin.ts contains `import 'server-only'`
7. server.ts uses `await cookies()` (async) and getAll/setAll
</verification>

<success_criteria>
- Next.js 16 project runs locally with Tailwind v4 organic theme
- All 3 Supabase clients created with correct patterns (browser/server/admin)
- proxy.ts handles token refresh via getClaims() and redirects unauthenticated users
- Build passes with zero TypeScript errors
- All dependencies installed (tRPC, Supabase, React Query, zod, superjson, etc.)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
