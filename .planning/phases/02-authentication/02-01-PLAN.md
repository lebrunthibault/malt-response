---
phase: 02-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/(auth)/login/page.tsx
  - src/app/(auth)/login/actions.ts
  - src/app/(auth)/callback/route.ts
  - src/app/(app)/layout.tsx
  - src/app/(app)/loading.tsx
  - src/components/layout/sidebar.tsx
  - src/components/layout/user-menu.tsx
  - src/proxy.ts
autonomous: false
user_setup:
  - service: supabase
    why: "OTP email delivery requires configured Supabase auth"
    dashboard_config:
      - task: "Configure OTP email template to use {{ .Token }} (not {{ .ConfirmationURL }})"
        location: "Supabase Dashboard -> Authentication -> Email Templates -> Confirm signup"
      - task: "Ensure email auth provider is enabled with OTP"
        location: "Supabase Dashboard -> Authentication -> Providers -> Email"

must_haves:
  truths:
    - "User can enter email on /login and receive a 6-digit OTP code by email"
    - "User can enter OTP code and get redirected to /generate (or their original destination)"
    - "User sees friendly French error messages when OTP is wrong or expired"
    - "User sees rate limit countdown (e.g. 'Réessayez dans 19 secondes') instead of generic error"
    - "User can resend OTP code from the verification step"
    - "Unauthenticated users are silently redirected to /login with return URL preserved"
    - "Auth loading state shows skeleton layout (no flash of protected content)"
    - "User can log out from a user menu dropdown in the sidebar"
    - "User can access /profile from the user menu dropdown"
  artifacts:
    - path: "src/app/(auth)/login/actions.ts"
      provides: "Server Actions for OTP request and verification"
      exports: ["requestOtpAction", "verifyOtpAction"]
    - path: "src/app/(auth)/login/page.tsx"
      provides: "Login page with email input and OTP verification"
      min_lines: 60
    - path: "src/components/layout/user-menu.tsx"
      provides: "User menu dropdown with logout and profile link"
      min_lines: 30
    - path: "src/app/(app)/loading.tsx"
      provides: "Skeleton loading state for authenticated pages"
      min_lines: 10
    - path: "src/proxy.ts"
      provides: "Return URL preservation in redirect"
      contains: "redirect"
  key_links:
    - from: "src/app/(auth)/login/page.tsx"
      to: "src/app/(auth)/login/actions.ts"
      via: "Server Action form submission"
      pattern: "requestOtpAction|verifyOtpAction"
    - from: "src/app/(auth)/login/actions.ts"
      to: "supabase.auth.signInWithOtp"
      via: "Supabase Auth API"
      pattern: "signInWithOtp|verifyOtp"
    - from: "src/components/layout/user-menu.tsx"
      to: "supabase.auth.signOut"
      via: "Browser client sign out"
      pattern: "signOut"
    - from: "src/proxy.ts"
      to: "/login"
      via: "Redirect with ?redirect= parameter"
      pattern: "redirect="
    - from: "src/components/layout/sidebar.tsx"
      to: "src/components/layout/user-menu.tsx"
      via: "Component composition at sidebar bottom"
      pattern: "UserMenu"
---

<objective>
Implement the complete OTP authentication flow, route protection with return URL, and user menu dropdown.

Purpose: Users can sign in via email OTP, stay logged in across sessions, and access logout/profile from a sidebar user menu. This is the gate to all authenticated features.

Output: Working login page with OTP flow, skeleton loading states, user menu with logout, and return URL preservation in proxy.
</objective>

<execution_context>
@/home/thibault/.claude/get-shit-done/workflows/execute-plan.md
@/home/thibault/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-authentication/02-CONTEXT.md
@.planning/phases/02-authentication/02-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
@.planning/phases/01-foundation/01-03-SUMMARY.md
@src/proxy.ts
@src/lib/supabase/server.ts
@src/lib/supabase/client.ts
@src/app/(auth)/login/page.tsx
@src/app/(auth)/callback/route.ts
@src/app/(app)/layout.tsx
@src/components/layout/sidebar.tsx
@src/components/layout/header.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: OTP login flow with Server Actions</name>
  <files>
    src/app/(auth)/login/actions.ts
    src/app/(auth)/login/page.tsx
    src/app/(auth)/callback/route.ts
  </files>
  <action>
**Install required shadcn/ui components first:**
```bash
npx shadcn@latest add input label form
```
Also install react-hook-form and @hookform/resolvers if not present (check package.json first).

**Create `src/app/(auth)/login/actions.ts`** with two Server Actions:

1. `requestOtpAction(formData: FormData)` — extracts email, validates non-empty/email format with Zod, calls `supabase.auth.signInWithOtp({ email, options: { shouldCreateUser: true } })`. Returns `{ success: true }` or `{ success: false, error: string }`. Use createClient() from @/lib/supabase/server.

2. `verifyOtpAction(formData: FormData)` — extracts email, token (6-digit code), and redirectTo. Calls `supabase.auth.verifyOtp({ email, token, type: 'email' })`. On success, validates redirectTo (must start with `/` and NOT start with `//` to prevent open redirect), then calls `redirect(redirectTo || '/generate')`. On error, returns `{ success: false, error: string }` with French messages:
   - `invalid_credentials` or generic: "Code incorrect — verifiez votre email et reessayez"
   - `otp_expired`: "Code expire — demandez un nouveau code"
   - `over_email_send_rate_limit`: "Réessayez dans {X} secondes" (extract seconds from error.message via regex `/after (\d+) seconds/`), fallback: "Trop de tentatives — réessayez dans quelques instants"

Mark both with `'use server'` at top of file.

**Replace `src/app/(auth)/login/page.tsx`** with a client component ('use client') that has two states:

State 1 — Email entry:
- Centered card layout (keep existing structure but replace placeholder)
- Title: "Connexion"
- Subtitle: "Connectez-vous avec votre email"
- Email input with label "Email"
- Submit button: "Envoyer le code" (shows spinner while pending)
- Use useActionState (from React 19) to call requestOtpAction
- On success, transition to State 2, storing email in local state

State 2 — OTP verification:
- Same card layout
- Title: "Verification"
- Subtitle: "Entrez le code envoye a {email}"
- 6-digit text input (inputMode="numeric", maxLength 6, autoFocus)
- Hidden input for email (passed through from State 1)
- Hidden input for redirectTo (read from URL searchParams via useSearchParams)
- Submit button: "Se connecter" (shows spinner while pending)
- Link/button below: "Renvoyer le code" — calls requestOtpAction again
- Link: "Utiliser une autre adresse" — returns to State 1
- Error display: red text above submit button with error message from action
- "Renvoyer le code" must always be visible (per user decision)

Use React 19 useActionState for form submissions. Use useSearchParams() to read `?redirect=` parameter from URL.

**Update `src/app/(auth)/callback/route.ts`:**
- Read `redirect` query param from searchParams
- Validate redirect URL (must start with `/`, not `//`)
- After successful code exchange, redirect to validated URL or fallback to `/generate`
- This route handles magic link fallback if ever needed; OTP flow uses verifyOtpAction directly

NOTE: The OTP flow uses verifyOtp Server Action (not the callback route). The callback route is a fallback for code-based exchanges. Keep both working.
  </action>
  <verify>
- `npm run build` passes with zero TypeScript errors
- `src/app/(auth)/login/actions.ts` exports requestOtpAction and verifyOtpAction
- `src/app/(auth)/login/page.tsx` contains both email and OTP states
- Login page renders at /login with email input
  </verify>
  <done>
- Login page shows email input form in centered card
- Submitting email calls requestOtpAction Server Action
- OTP step shows 6-digit input with resend and change-email options
- Submitting OTP calls verifyOtpAction which redirects on success
- French error messages displayed on failure
- Callback route preserves redirect parameter
  </done>
</task>

<task type="auto">
  <name>Task 2: User menu, route protection, and loading skeleton</name>
  <files>
    src/components/layout/user-menu.tsx
    src/components/layout/sidebar.tsx
    src/app/(app)/layout.tsx
    src/app/(app)/loading.tsx
    src/proxy.ts
  </files>
  <action>
**Install required shadcn/ui components:**
```bash
npx shadcn@latest add dropdown-menu avatar
```

**Create `src/components/layout/user-menu.tsx`** — a client component ('use client'):
- Import createClient from @/lib/supabase/client (browser client)
- Import useRouter from next/navigation
- Props: `user: { email: string; displayName?: string | null }` (passed from server)
- Renders a DropdownMenu (from shadcn/ui):
  - Trigger: Avatar with user initial (first letter of displayName or email) + display name or email text, styled to fit sidebar bottom area
  - Menu items:
    1. "Mon profil" — links to /profile (use router.push or Link)
    2. Separator
    3. "Se deconnecter" — calls `supabase.auth.signOut()` then `router.push('/login')` then `router.refresh()`
- Style: fits the sidebar bottom area, replacing the current "v0.1.0" text

**Modify `src/components/layout/sidebar.tsx`:**
- Remove "Profil" from navItems array (per user decision: profile accessed from user menu only, NOT in main nav)
- Keep the navigation items as: Generer, Documents, Historique (and Admin below separator)
- Add UserMenu component at the bottom of the sidebar (replacing the v0.1.0 text div)
- Accept `user` prop: `{ email: string; displayName?: string | null }` and pass to UserMenu
- Export the Sidebar component with this new prop

**Modify `src/app/(app)/layout.tsx`:**
- Make it an async Server Component
- Import createClient from @/lib/supabase/server
- Fetch user via `supabase.auth.getUser()` and profile via `supabase.from('profiles').select('display_name').eq('id', user.id).single()`
- Pass user data (email + display_name) to Sidebar component
- If no user (shouldn't happen due to proxy, but defensive), pass fallback values

**Modify `src/proxy.ts`:**
- When redirecting unauthenticated users to /login, preserve the originally requested path as a query parameter: `url.searchParams.set('redirect', request.nextUrl.pathname)`
- This enables return-to-original-page after login
- Keep existing logic: skip /login, /auth, /api, / routes

**Create `src/app/(app)/loading.tsx`:**
- Export a default component that renders a skeleton layout matching the app shell
- Show a skeleton header bar (animated pulse) and content area with 3-4 skeleton blocks
- Use Tailwind animate-pulse on gray bg-muted rounded blocks
- This prevents flash of protected content during auth check
- Keep it simple: no shadcn skeleton component needed, just div with animate-pulse classes
  </action>
  <verify>
- `npm run build` passes with zero TypeScript errors
- Sidebar no longer shows "Profil" in main navigation
- UserMenu component renders dropdown with "Mon profil" and "Se deconnecter"
- loading.tsx exists at (app)/loading.tsx
- proxy.ts redirect includes `?redirect=` parameter
  </verify>
  <done>
- User menu dropdown appears at bottom of sidebar with avatar initial and name/email
- Clicking "Se deconnecter" signs out and redirects to /login
- Clicking "Mon profil" navigates to /profile
- "Profil" removed from sidebar main navigation
- Skeleton loading state shows during page transitions
- proxy.ts preserves return URL in redirect to /login
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete OTP authentication flow: login page with email/OTP entry, user menu dropdown in sidebar with logout/profile, skeleton loading state, and return URL preservation.</what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Visit http://localhost:3000 — should redirect to /login (if Supabase is configured)
3. On /login page: enter your email, click "Envoyer le code"
4. Check your email for OTP code
5. Enter the 6-digit code, click "Se connecter"
6. Should redirect to /generate
7. Check sidebar: "Profil" should NOT be in main nav links
8. Click your name/avatar at bottom of sidebar — dropdown should appear
9. Click "Mon profil" — should navigate to /profile
10. Click your name again, then "Se deconnecter" — should redirect to /login
11. Try accessing /documents directly while logged out — should redirect to /login?redirect=/documents
12. Log in again — should redirect to /documents (return URL preserved)
13. Refresh the page while logged in — should stay logged in (session persists)
14. Check loading state: navigate between pages, brief skeleton should appear

If Supabase is not yet configured (placeholder credentials), verify:
- Login page renders correctly with email form
- Components exist and build passes
- Visual layout looks clean
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- `npm run build` succeeds with zero TypeScript errors
- Login flow: email -> OTP -> redirect works end-to-end
- Logout: user menu -> "Se deconnecter" -> /login
- Route protection: unauthenticated access redirects to /login with return URL
- Session persistence: refresh keeps user logged in
- No "Profil" in sidebar main nav (only in user menu dropdown)
</verification>

<success_criteria>
1. User can enter email on /login and receive OTP code
2. User can verify OTP and get redirected to app
3. User can log out from sidebar user menu dropdown
4. Unauthenticated access redirects silently to /login with return URL
5. After login, user returns to originally requested page
6. Session persists across browser refresh
7. Skeleton loading state prevents flash of protected content
8. Profile accessible from user menu dropdown, not sidebar nav
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-01-SUMMARY.md`
</output>
