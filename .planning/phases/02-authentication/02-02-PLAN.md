---
phase: 02-authentication
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/trpc/routers/profile.ts
  - src/trpc/routers/_app.ts
  - src/app/(app)/profile/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can see their profile page with their name and email displayed"
    - "User can click on their name to edit it inline"
    - "User can save their edited name and it persists across page refresh"
    - "User sees their email as read-only (cannot edit)"
    - "User sees immediate feedback when name is saved (success state)"
  artifacts:
    - path: "src/trpc/routers/profile.ts"
      provides: "Profile CRUD via tRPC"
      exports: ["profileRouter"]
    - path: "src/app/(app)/profile/page.tsx"
      provides: "Profile page with inline name editing"
      min_lines: 40
  key_links:
    - from: "src/app/(app)/profile/page.tsx"
      to: "src/trpc/routers/profile.ts"
      via: "tRPC hooks (trpc.profile.get, trpc.profile.update)"
      pattern: "trpc\\.profile\\.(get|update)"
    - from: "src/trpc/routers/profile.ts"
      to: "profiles table"
      via: "Supabase query"
      pattern: "from\\(['\"]profiles['\"]\\)"
    - from: "src/trpc/routers/_app.ts"
      to: "src/trpc/routers/profile.ts"
      via: "Router merge"
      pattern: "profile: profileRouter"
---

<objective>
Implement the profile page with tRPC-backed inline name editing and read-only email display.

Purpose: Users can view and update their display name from the profile page, accessed via the user menu dropdown built in Plan 01.

Output: Working profile page with inline edit for name, read-only email, and tRPC profile router.
</objective>

<execution_context>
@/home/thibault/.claude/get-shit-done/workflows/execute-plan.md
@/home/thibault/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-authentication/02-CONTEXT.md
@.planning/phases/02-authentication/02-RESEARCH.md
@.planning/phases/02-authentication/02-01-SUMMARY.md
@src/trpc/init.ts
@src/trpc/routers/_app.ts
@src/app/(app)/profile/page.tsx
@supabase/migrations/001_initial_schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: tRPC profile router</name>
  <files>
    src/trpc/routers/profile.ts
    src/trpc/routers/_app.ts
  </files>
  <action>
**Create `src/trpc/routers/profile.ts`:**

Import authedProcedure and createTRPCRouter from @/trpc/init. Import z from zod.

Two procedures:

1. `get` — authedProcedure query:
   - Queries `profiles` table: `supabase.from('profiles').select('display_name, email').eq('id', ctx.user.id).single()`
   - Returns `{ displayName: string | null, email: string }`
   - Throws TRPCError NOT_FOUND if profile doesn't exist (shouldn't happen due to trigger, but defensive)

2. `update` — authedProcedure mutation:
   - Input: `z.object({ displayName: z.string().min(1).max(100).trim() })`
   - Updates profiles table: `supabase.from('profiles').update({ display_name: input.displayName, updated_at: new Date().toISOString() }).eq('id', ctx.user.id)`
   - Also updates auth.users metadata for consistency: `supabase.auth.updateUser({ data: { display_name: input.displayName } })`
   - Returns `{ success: true }`
   - Throws TRPCError INTERNAL_SERVER_ERROR on database failure

Export profileRouter.

**Modify `src/trpc/routers/_app.ts`:**
- Import profileRouter from './profile'
- Add `profile: profileRouter` to createTRPCRouter call
  </action>
  <verify>
- `npm run build` passes with zero TypeScript errors
- `src/trpc/routers/profile.ts` exports profileRouter
- `src/trpc/routers/_app.ts` includes profile router
- Profile endpoints visible at /api/trpc (profile.get, profile.update)
  </verify>
  <done>
- tRPC profile.get returns user's display_name and email
- tRPC profile.update accepts displayName string and updates both profiles table and auth metadata
- Profile router wired into app router
  </done>
</task>

<task type="auto">
  <name>Task 2: Profile page with inline name editing</name>
  <files>
    src/app/(app)/profile/page.tsx
  </files>
  <action>
**Install required shadcn/ui components if not already present:**
```bash
npx shadcn@latest add input
```
(Input may already be installed from Plan 01; check first, skip if exists.)

**Replace `src/app/(app)/profile/page.tsx`** with a client component ('use client'):

Import Header from @/components/layout/header, trpc from @/trpc/client, and required shadcn/ui components.

Layout:
- Header with title "Profil"
- Content area with two sections:

Section 1 — Name (editable):
- Label: "Nom"
- View mode (default): displays name text + a "Modifier" button/link
  - If no name set, show italic "Non defini" placeholder
- Edit mode (after clicking Modifier): input field pre-filled with current name + "Enregistrer" button + "Annuler" link
  - On "Enregistrer": call trpc.profile.update.useMutation with { displayName: newValue }
  - On success: exit edit mode, invalidate trpc.profile.get query (React Query cache), show brief success state (e.g., green check icon that fades after 2s)
  - On error: show error message below input
  - On "Annuler": revert input to original value, exit edit mode
- Use local state for isEditing boolean and editValue string

Section 2 — Email (read-only):
- Label: "Email"
- Display email text with muted styling
- Small note below: "L'email est lie a votre compte et ne peut pas etre modifie"

Data fetching:
- Use `trpc.profile.get.useQuery()` to load profile data
- Show loading skeleton while data loads (animate-pulse placeholders)
- Show error state if query fails

Styling: clean, minimal. Use consistent spacing. Follow the organic theme. No card wrapper needed - simple content within the page max-width container.
  </action>
  <verify>
- `npm run build` passes with zero TypeScript errors
- Profile page loads at /profile showing name and email
- Clicking "Modifier" on name switches to edit mode
- Name can be edited and saved
  </verify>
  <done>
- Profile page shows display name (or "Non defini") with "Modifier" button
- Clicking "Modifier" shows inline input with save/cancel
- Saving updates name via tRPC and shows success feedback
- Email displayed as read-only with explanatory note
- Loading state shows skeleton while data loads
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Profile page with tRPC-backed inline name editing and read-only email display.</what-built>
  <how-to-verify>
1. Log in to the app (using OTP from Plan 01)
2. Click your name/avatar in sidebar user menu
3. Click "Mon profil" from the dropdown
4. Profile page should show your email (read-only) and name section
5. Click "Modifier" next to your name
6. Type a new name, click "Enregistrer"
7. Name should update with brief success feedback
8. Refresh the page — name should persist
9. Check sidebar user menu — name should update there too (after refresh)
10. Try clicking "Annuler" during edit — should revert
11. Try submitting empty name — should show validation error
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- `npm run build` succeeds with zero TypeScript errors
- Profile page shows name (inline editable) and email (read-only)
- Name changes persist in database and reflect in user menu
- tRPC profile router handles get and update
</verification>

<success_criteria>
1. User can view their profile with name and email
2. User can inline-edit their name (click to edit, save, cancel)
3. Updated name persists across page refresh
4. Email shown as read-only with explanation text
5. Profile data fetched via tRPC with loading/error states
6. Name update writes to both profiles table and auth metadata
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication/02-02-SUMMARY.md`
</output>
